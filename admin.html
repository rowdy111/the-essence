<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel - The Essence Chat</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #111;
        color: white;
        margin: 0;
    }

    /* Login screen */
    #loginScreen {
        width: 100%;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    #loginScreen input {
        padding: 10px;
        margin: 5px;
        width: 250px;
        border-radius: 6px;
        border: none;
        outline: none;
    }

    #loginScreen button {
        padding: 10px 20px;
        background: #ff0077;
        border: none;
        border-radius: 6px;
        color: white;
        cursor: pointer;
        font-size: 16px;
    }

    /* Dashboard */
    #adminPanel {
        display: none;
        padding: 20px;
    }

    .userBox {
        background: #222;
        margin: 12px 0;
        padding: 12px;
        border-radius: 10px;
    }

    .messages {
        background: #333;
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
    }

    .sent {
        text-align: right;
        color: #00eaff;
    }

    .received {
        text-align: left;
        color: #ff62b7;
    }

    input[type=text] {
        width: 80%;
        padding: 10px;
        border-radius: 6px;
        border: none;
        outline: none;
    }

    button {
        padding: 8px 15px;
        background: #ff0077;
        border: none;
        border-radius: 6px;
        color: white;
        cursor: pointer;
        margin-top: 5px;
    }

    .deleteBtn {
        background: red;
    }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
    <h2>Admin Login</h2>
    <input id="username" type="text" placeholder="Enter Username">
    <input id="password" type="password" placeholder="Enter Password">
    <button onclick="login()">Login</button>
    <p id="loginError" style="color:red;"></p>
</div>

<!-- ADMIN DASHBOARD -->
<div id="adminPanel">
    <h1>Admin Dashboard</h1>
    <h3>All User Chats</h3>
    <div id="userList"></div>
</div>

<script type="module">
/* --------------------- Firebase Setup ---------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBwEIiGPtOKWatNnYuIWzmZe3yUQgLAhxc",
    authDomain: "theessencechat.firebaseapp.com",
    databaseURL: "https://theessencechat-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "theessencechat",
    storageBucket: "theessencechat.firebasestorage.app",
    messagingSenderId: "704836914944",
    appId: "1:704836914944:web:a359fa74bdecbf0c212de5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* --------------------- Admin Login ---------------------- */
function login() {
    const user = document.getElementById("username").value;
    const pass = document.getElementById("password").value;

    if (user === "bibekji" && pass === "essencebbk5") {
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("adminPanel").style.display = "block";
        loadChats();
    } else {
        document.getElementById("loginError").textContent = "Invalid username or password!";
    }
}

window.login = login;

/* --------------------- Load All User Chats ---------------------- */
function loadChats() {
    const chatsRef = ref(db, "chats/");

    onValue(chatsRef, (snapshot) => {
        const userList = document.getElementById("userList");
        userList.innerHTML = "";

        snapshot.forEach((userChat) => {
            const userId = userChat.key;
            const messages = userChat.val();

            const box = document.createElement("div");
            box.className = "userBox";

            box.innerHTML = `
                <h3>User: ${userId}</h3>
                <button class="deleteBtn" onclick="deleteConversation('${userId}')">Delete Conversation</button>
                <div class="messages" id="msg-${userId}"></div>
                <input type="text" id="reply-${userId}" placeholder="Reply message...">
                <button onclick="sendReply('${userId}')">Send Reply</button>
            `;

            userList.appendChild(box);

            const msgBox = document.getElementById(`msg-${userId}`);
            msgBox.innerHTML = "";

            for (let msgId in messages) {
                const msg = messages[msgId];

                msgBox.innerHTML += `
                    <p class="${msg.sender === 'user' ? 'sent' : 'received'}">
                        ${msg.text}
                        <button class="deleteBtn" style="font-size:10px" onclick="deleteMessage('${userId}', '${msgId}')">X</button>
                    </p>
                `;
            }
        });
    });
}

/* --------------------- Send Reply to User ---------------------- */
window.sendReply = function(userId) {
    const input = document.getElementById(`reply-${userId}`);
    const text = input.value.trim();
    if (text === "") return;

    push(ref(db, "chats/" + userId), {
        sender: "admin",
        text: text,
        time: Date.now()
    });

    input.value = "";
};

/* --------------------- Delete Single Message ---------------------- */
window.deleteMessage = function(userId, msgId) {
    remove(ref(db, `chats/${userId}/${msgId}`));
};

/* --------------------- Delete Entire Conversation ---------------------- */
window.deleteConversation = function(userId) {
    if (confirm("Delete entire chat?")) {
        remove(ref(db, "chats/" + userId));
    }
};

</script>

</body>
</html>

